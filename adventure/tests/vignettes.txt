>>> import io
>>> from itertools import cycle, islice

This file tests the behavior of the Adventure game in all sorts of
specific situations that would be very tedious to arrange in actual
walkthroughs.  As the basis for these tests, we will begin by starting a
game, entering the building, and carrying the lamp.

>>> import adventure
>>> adventure.play(seed=3)
WELCOME TO ADVENTURE!!  WOULD YOU LIKE INSTRUCTIONS?
<BLANKLINE>
>>> no
YOU ARE STANDING AT THE END OF A ROAD BEFORE A SMALL BRICK BUILDING.
AROUND YOU IS A FOREST.  A SMALL STREAM FLOWS OUT OF THE BUILDING AND
DOWN A GULLY.
<BLANKLINE>
>>> brief
OKAY, FROM NOW ON I'LL ONLY DESCRIBE A PLACE IN FULL THE FIRST TIME
YOU COME TO IT.  TO GET THE FULL DESCRIPTION, SAY "LOOK".
<BLANKLINE>
>>> enter
YOU ARE INSIDE A BUILDING, A WELL HOUSE FOR A LARGE SPRING.
<BLANKLINE>
THERE ARE SOME KEYS ON THE GROUND HERE.
<BLANKLINE>
THERE IS A SHINY BRASS LAMP NEARBY.
<BLANKLINE>
THERE IS FOOD HERE.
<BLANKLINE>
THERE IS A BOTTLE OF WATER HERE.
<BLANKLINE>
>>> on
YOUR LAMP IS NOW ON.
<BLANKLINE>
>>> get(lamp)
OK
<BLANKLINE>

Now we can save this game.

>>> savefile = io.BytesIO()
>>> save(savefile)
GAME SAVED
<BLANKLINE>

Now, all of the tests below can begin by calling this restart() function
to place them back at the beginning of the adventure in a known state.
If a room is specified, note that restart() performs two turns in the
room before handing back control: the first when it asks the game to
move the caller into that room, and the second when it calls look().

>>> def restart(room=None, objects=(), randoms=None):
...     global game
...     savefile.seek(0)
...     adventure.resume(savefile, quiet=True)
...     game = adventure._game
...     if room is not None:
...         goto(room)
...     room = game.loc
...     for obj in objects:
...         if not isinstance(obj, adventure.model.Object):
...             obj = game.referent(game.vocabulary[obj.word])
...         obj.drop(room)
...     message = repr(look)
...     if randoms is not None:
...         game.random = list(randoms).pop
...     return adventure.prompt.ReprString(message)

>>> def goto(room):
...     if isinstance(room, int):
...         room = game.rooms[room]
...     game.move_to(room)
...     return look

>>> def quiet(*args):
...     for arg in args:
...         repr(arg)
...     return None

With those definitions complete, we can proceed with the actual tests!

If the dwarves activate when we are standing in one of their starting
rooms, then does the dwarf at our location get moved successfully to the
gold nuggets room?

>>> restart(room=41, randoms=[None, .9, .9, .99])
YOU ARE AT THE WEST END OF HALL OF MISTS.  A LOW WIDE CRAWL CONTINUES
WEST AND ANOTHER GOES NORTH.  TO THE SOUTH IS A LITTLE PASSAGE 6 FEET
OFF THE FLOOR.
<BLANKLINE>
>>> [ dwarf.room.n for dwarf in game.dwarves ]
[19, 27, 33, 44, 64]
>>> e
A LITTLE DWARF JUST WALKED AROUND A CORNER, SAW YOU, THREW A LITTLE
AXE AT YOU WHICH MISSED, CURSED, AND RAN AWAY.
<BLANKLINE>
YOU ARE ON THE WEST SIDE OF THE FISSURE IN THE HALL OF MISTS.
<BLANKLINE>
THERE IS A LITTLE AXE HERE.
<BLANKLINE>
THERE ARE DIAMONDS HERE!
<BLANKLINE>
>>> [ dwarf.room.n for dwarf in game.dwarves ]
[19, 18, 33, 44, 64]

If the pirate encounters us in the plover room or dark room, does he
leave the platinum pyramid since learning how to remove it from the room
is one of the game's puzzles?

>>> restart(room=100, objects=[pyramid])
YOU'RE IN A SMALL CHAMBER LIT BY AN EERIE GREEN LIGHT.  AN EXTREMELY
NARROW TUNNEL EXITS TO THE WEST.  A DARK CORRIDOR LEADS NE.
<BLANKLINE>
THERE IS AN EMERALD HERE THE SIZE OF A PLOVER'S EGG!
<BLANKLINE>
THERE IS A PLATINUM PYRAMID HERE, 8 INCHES ON A SIDE!
<BLANKLINE>
>>> get(pyramid)
OK
<BLANKLINE>
>>> get(emerald)
OK
<BLANKLINE>
>>> del game.dwarves[:]
>>> game.dwarf_stage = 2
>>> game.pirate.room = game.loc
>>> look
OUT FROM THE SHADOWS BEHIND YOU POUNCES A BEARDED PIRATE!  "HAR, HAR,"
HE CHORTLES, "I'LL JUST TAKE ALL THIS BOOTY AND HIDE IT AWAY WITH ME
CHEST DEEP IN THE MAZE!"  HE SNATCHES YOUR TREASURE AND VANISHES INTO
THE GLOOM.
<BLANKLINE>
YOU'RE IN A SMALL CHAMBER LIT BY AN EERIE GREEN LIGHT.  AN EXTREMELY
NARROW TUNNEL EXITS TO THE WEST.  A DARK CORRIDOR LEADS NE.
<BLANKLINE>
>>> inventory
YOU ARE CURRENTLY HOLDING THE FOLLOWING:
<BLANKLINE>
BRASS LANTERN
PLATINUM PYRAMID
<BLANKLINE>

If we manage to collect all of the treasures before the pirate spots us,
then when we find him he goes to hide his treasure chest in the maze
without any other treasures to accompany it.

>>> quiet(restart())
>>> for t in game.treasures:
...     if t == 'chest': continue
...     t.drop(game.loc)
>>> quiet(look)
>>> game.dwarf_stage = 2
>>> game.loc = game.pirate.room = game.rooms[69]
>>> look
THERE ARE FAINT RUSTLING NOISES FROM THE DARKNESS BEHIND YOU.  AS YOU
TURN TOWARD THEM, THE BEAM OF YOUR LAMP FALLS ACROSS A BEARDED PIRATE.
HE IS CARRYING A LARGE CHEST.  "SHIVER ME TIMBERS!" HE CRIES, "I'VE
BEEN SPOTTED!  I'D BEST HIE MESELF OFF TO THE MAZE TO HIDE ME CHEST!"
WITH THAT, HE VANISHES INTO THE GLOOM.
<BLANKLINE>
YOU ARE IN A SECRET N/S CANYON ABOVE A LARGE ROOM.
<BLANKLINE>
>>> goto(game.chest_room)
DEAD END
<BLANKLINE>
THE PIRATE'S TREASURE CHEST IS HERE!
<BLANKLINE>

If several dwarves throw knives that hit us, does a sensible message result?

>>> quiet(restart(room=75, randoms=(.05,.05,.05,.05,.05,.05)))
>>> game.dwarf_stage = 3
>>> for dwarf in game.dwarves:
...     dwarf.room = game.rooms[75]
>>> look
THERE ARE 5 THREATENING LITTLE DWARVES IN THE ROOM WITH YOU.
<BLANKLINE>
5 OF THEM THROW KNIVES AT YOU!
<BLANKLINE>
5 OF THEM GET YOU!
<BLANKLINE>
OH DEAR, YOU SEEM TO HAVE GOTTEN YOURSELF KILLED.  I MIGHT BE ABLE TO
HELP YOU OUT, BUT I'VE NEVER REALLY DONE THIS BEFORE.  DO YOU WANT ME
TO TRY TO REINCARNATE YOU?
<BLANKLINE>

If, when a treasure is found, the game figures out that all remaining
treasures are impossible to acquire - like the jewelry in the south side
chamber of the Hall of the Mountain King, if the bird dies before the
snake is driven away - then the lamp should be reduced to only having 35
turns left.

>>> quiet(restart())
>>> for t in game.treasures:
...     if t == 'jewelry' or t == 'silver': continue
...     t.drop(game.loc)
>>> quiet(look)
>>> game.bird.carry()
>>> goto(119)
YOU ARE IN A SECRET CANYON WHICH EXITS TO THE NORTH AND EAST.
<BLANKLINE>
A HUGE GREEN FIERCE DRAGON BARS THE WAY!
<BLANKLINE>
>>> drop(bird)
THE LITTLE BIRD ATTACKS THE GREEN DRAGON, AND IN AN ASTOUNDING FLURRY
GETS BURNT TO A CINDER.  THE ASHES BLOW AWAY.
<BLANKLINE>
>>> game.lamp_turns
324
>>> goto(28)
YOU ARE IN A LOW N/S PASSAGE AT A HOLE IN THE FLOOR.  THE HOLE GOES
DOWN TO AN E/W PASSAGE.
<BLANKLINE>
THERE ARE BARS OF SILVER HERE!
<BLANKLINE>
>>> game.lamp_turns
34

If you act confused, the game should offer you a hint.  Here are quick
(but certainly not thorough!) tests of whether the logic for each hint
allows it to be offered.

>>> quiet(restart(room=8), look)
>>> look
YOU ARE IN A 20-FOOT DEPRESSION FLOORED WITH BARE DIRT.  SET INTO THE
DIRT IS A STRONG STEEL GRATE MOUNTED IN CONCRETE.  A DRY STREAMBED
LEADS INTO THE DEPRESSION.
<BLANKLINE>
THE GRATE IS LOCKED.
<BLANKLINE>
ARE YOU TRYING TO GET INTO THE CAVE?
<BLANKLINE>
>>> yes
THE GRATE IS VERY SOLID AND HAS A HARDENED STEEL LOCK.  YOU CANNOT
ENTER WITHOUT A KEY, AND THERE ARE NO KEYS NEARBY.  I WOULD RECOMMEND
LOOKING ELSEWHERE FOR THE KEYS.
<BLANKLINE>

>>> quiet(restart(room=13, objects=[rod]), get(rod), look)
>>> get(bird)
THE BIRD WAS UNAFRAID WHEN YOU ENTERED, BUT AS YOU APPROACH IT BECOMES
DISTURBED AND YOU CANNOT CATCH IT.
<BLANKLINE>
ARE YOU TRYING TO CATCH THE BIRD?
<BLANKLINE>
>>> no
OK
<BLANKLINE>

>>> quiet(restart(room=19), look, look, look, look, look)
>>> look
YOU ARE IN THE HALL OF THE MOUNTAIN KING, WITH PASSAGES OFF IN ALL
DIRECTIONS.
<BLANKLINE>
A HUGE GREEN FIERCE SNAKE BARS THE WAY!
<BLANKLINE>
THERE IS A LITTLE AXE HERE.
<BLANKLINE>
ARE YOU TRYING TO SOMEHOW DEAL WITH THE SNAKE?
<BLANKLINE>

>>> quiet(restart(room=42), s, n)
>>> get(axe)
OK
<BLANKLINE>
>>> del game.dwarves[:]
>>> quiet(*islice(cycle((w, s, n)), 75 - 6))
>>> look
YOU ARE IN A MAZE OF TWISTY LITTLE PASSAGES, ALL ALIKE.
<BLANKLINE>
DO YOU NEED HELP GETTING OUT OF THE MAZE?
<BLANKLINE>
>>> yes
YOU CAN MAKE THE PASSAGES LOOK LESS ALIKE BY DROPPING THINGS.
<BLANKLINE>

>>> quiet(restart(room=99))
>>> game.dwarf_stage = 2
>>> del game.dwarves[:]
>>> quiet([ look ] * (25 - 3))
>>> look
YOU ARE IN AN ALCOVE.  A SMALL NW PATH SEEMS TO WIDEN AFTER A SHORT
DISTANCE.  AN EXTREMELY TIGHT TUNNEL LEADS EAST.  IT LOOKS LIKE A VERY
TIGHT SQUEEZE.  AN EERIE LIGHT CAN BE SEEN AT THE OTHER END.
<BLANKLINE>
ARE YOU TRYING TO EXPLORE BEYOND THE PLOVER ROOM?
<BLANKLINE>

>>> quiet(restart(room=108), [ look ] * (20 - 3))
>>> del game.dwarves[:]
>>> look
YOU ARE AT WITT'S END.  PASSAGES LEAD OFF IN *ALL* DIRECTIONS.
<BLANKLINE>
THERE IS A LITTLE AXE HERE.
<BLANKLINE>
DO YOU NEED HELP GETTING OUT OF HERE?
<BLANKLINE>
